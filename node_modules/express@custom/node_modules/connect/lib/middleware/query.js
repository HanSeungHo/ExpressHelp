/*!
 * Connect - query
 * Copyright(c) 2011 TJ Holowaychuk
 * Copyright(c) 2011 Sencha Inc.
 * MIT Licensed
 */

/**
 * Module dependencies.
 */

var qs = require('qs')
  , parse = require('../utils').parseUrl;
var url = require('url');
var URLDecode = require('./URLDecode');



/**
 * Query:
 *
 * Automatically parse the query-string when available,
 * populating the `req.query` object.
 *
 * Examples:
 *
 *     connect()
 *       .use(connect.query())
 *       .use(function(req, res){
 *         res.end(JSON.stringify(req.query));
 *       });
 *
 *  The `options` passed are provided to qs.parse function.
 *
 * @param {Object} options
 * @return {Function}
 * @api public
 */

module.exports = function query(options){
  return function query(req, res, next){
    if (!req.query) {
		if(req.url.indexOf('?') > 0){
			var uri = url.parse(req.url);
			var uriPath = uri.pathname;
			if(/^\/euc\-kr\-/.test(uriPath)){
				var urlquery = parse(req).query;
				var bodyquery = URLDecode(urlquery);
				req.query = qs.parse(encodeURI(bodyquery.toString()), options);
			} else {
				req.query = qs.parse(parse(req).query, options);
			}
		} else {
			req.query = {};
		}
      //req.query = ~req.url.indexOf('?')
      //  ? qs.parse(parse(req).query, options)
      //  : {};
    }

    next();
  };
};
