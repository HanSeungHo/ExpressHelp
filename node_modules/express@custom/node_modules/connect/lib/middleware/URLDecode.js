var Iconv = require('iconv').Iconv;								// npm install -g iconv@1.2.4
var conv = new Iconv('UTF-8','EUC-KR');
module.exports = function(encoded) {
	var HEXCHARS = "0123456789ABCDEFabcdef";
	//var plaintext = "";
	var plaintext = new Buffer(1024);
	var i = 0, j = 0;

	while (i < encoded.length)
	{
		var ch = encoded.charAt(i);
		if (ch == "+")
		{
			//plaintext += " ";
			plaintext[j]=0x20;
			j++;
			i++;
		} else if (ch == "%")
		{
			if (i < (encoded.length-2)
				&& HEXCHARS.indexOf(encoded.charAt(i+1)) != -1
				&& HEXCHARS.indexOf(encoded.charAt(i+2)) != -1 )
			{
				//plaintext += unescape( encoded.substr(i,3) );
				plaintext[j] = parseInt("0x"+encoded.substr(i+1,2));
				j++;
				i += 3;
			} else {
				//alert( 'Bad escape combination near ...' + encoded.substr(i) );
				//plaintext += "%[ERROR]";
				i++;
			}
		} else {
			//plaintext += ch;
			plaintext[j++] = encoded.charCodeAt(i);
			i++;
		}
	} // while

	var convtext = plaintext.slice(0,j);
	
	var iconv = new Iconv('euc-kr','utf-8');
	var buffer = iconv.convert(convtext);
	return buffer;	
};